<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniFit Pro | Smart Campus Diet AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .screen { transition: opacity 0.3s ease; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen flex justify-center items-center p-4">

    <div class="w-full max-w-5xl bg-white rounded-3xl shadow-2xl overflow-hidden md:flex min-h-[750px] relative">
        
        <!-- LEFT SIDE: BRANDING -->
        <div class="hidden md:flex w-2/5 bg-gradient-to-br from-blue-700 to-indigo-900 p-10 flex-col justify-between relative overflow-hidden">
            <div class="absolute top-0 right-0 w-72 h-72 bg-blue-500 rounded-full filter blur-3xl opacity-20 translate-x-20 -translate-y-20"></div>
            
            <div class="relative z-10">
                <div class="flex items-center space-x-3 mb-12">
                    <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-lg">
                        <span class="text-blue-600 font-bold text-xl">U</span>
                    </div>
                    <span class="text-white font-bold text-xl tracking-wide">UniFit Pro</span>
                </div>
                
                <h1 class="text-4xl font-extrabold text-white leading-tight mb-4">
                    Transform Your<br>
                    <span class="text-blue-200">Campus Diet.</span>
                </h1>
            </div>

            <div class="relative z-10 flex justify-center my-8">
                <div class="relative w-48 h-48 flex items-center justify-center">
                    <div class="absolute inset-0 bg-blue-500 rounded-full filter blur-xl opacity-30"></div>
                    <div class="relative text-8xl">üèãÔ∏è</div>
                </div>
            </div>

            <div class="relative z-10 space-y-3">
                <div class="flex items-center space-x-3 bg-white/10 p-3 rounded-xl border border-white/10">
                    <div class="text-xl">üìä</div>
                    <div>
                        <div class="text-white font-semibold text-sm">Smart Tally</div>
                        <div class="text-blue-200 text-xs">Matches quantity to your goals.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT SIDE: MAIN APP -->
        <div class="w-full md:w-3/5 p-8 md:p-12 relative overflow-y-auto h-[750px]">
            
            <!-- Screen 1: Profile -->
            <div id="s1" class="screen">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-slate-800">Let's Set You Up! üöÄ</h2>
                    <p class="text-slate-500 mt-2">Enter your stats.</p>
                </div>
                <div class="space-y-5">
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase">Your Name</label>
                        <input type="text" id="userName" placeholder="e.g., Arjun" class="mt-2 w-full px-4 py-3.5 bg-slate-50 border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase">Age</label>
                            <input type="number" id="age" placeholder="20" class="mt-2 w-full px-4 py-3.5 bg-slate-50 border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase">Gender</label>
                            <select id="gender" class="mt-2 w-full px-4 py-3.5 bg-slate-50 border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase">Weight (kg)</label>
                            <input type="number" id="weight" placeholder="70" class="mt-2 w-full px-4 py-3.5 bg-slate-50 border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                        </div>
                        <div>
                            <div class="flex justify-between items-center">
                                <label class="text-xs font-bold text-slate-400 uppercase">Height</label>
                                <div class="flex items-center space-x-1 bg-slate-100 rounded-lg p-0.5">
                                    <button onclick="setHeightMode('cm')" id="btn-cm" class="text-xs px-2 py-1 rounded bg-blue-100 text-blue-700 font-semibold transition">CM</button>
                                    <button onclick="setHeightMode('ft')" id="btn-ft" class="text-xs px-2 py-1 rounded text-slate-500 transition">Ft</button>
                                </div>
                            </div>
                            <div id="input-cm" class="mt-2"><input type="number" id="heightCM" placeholder="175" class="w-full px-4 py-3.5 bg-slate-50 border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition"></div>
                            <div id="input-ft" class="mt-2 hidden flex space-x-2">
                                <input type="number" id="heightFt" placeholder="5" class="w-1/2 px-3 py-3.5 bg-slate-50 border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                                <input type="number" id="heightIn" placeholder="9" class="w-1/2 px-3 py-3.5 bg-slate-50 border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase">Primary Goal</label>
                        <select id="goal" class="mt-2 w-full px-4 py-3.5 bg-slate-50 border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                            <option value="loss">üî• Fat Loss</option>
                            <option value="maintain">üí™ Stay Fit</option>
                            <option value="gain">üèãÔ∏è Muscle Gain</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase">Diet Preference</label>
                        <select id="dietType" class="mt-2 w-full px-4 py-3.5 bg-slate-50 border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                            <option value="veg">ü•¶ Vegetarian</option>
                            <option value="non-veg">üçó Non-Vegetarian</option>
                        </select>
                    </div>
                </div>
                <button onclick="calculateGoals()" class="w-full mt-8 py-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-lg shadow-blue-500/30 transition transform hover:-translate-y-0.5">
                    Calculate My Calories ‚Üí
                </button>
            </div>

            <!-- Screen 2: Goals -->
            <div id="s2" class="screen hidden">
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-slate-800">Your Daily Target</h2>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-5 rounded-2xl text-white shadow-lg">
                        <div class="text-xs uppercase opacity-80 font-bold">Calories</div>
                        <div class="text-4xl font-bold mt-1" id="res-cal-target">0</div>
                    </div>
                    <div class="bg-white border border-slate-200 p-5 rounded-2xl shadow-sm">
                        <div class="text-xs uppercase text-slate-400 font-bold">Protein</div>
                        <div class="text-4xl font-bold text-slate-800 mt-1" id="res-pro-target">0g</div>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-xl">
                        <div class="text-xs text-slate-400 font-bold">Carbs</div>
                        <div class="text-2xl font-bold text-slate-700" id="res-carb-target">0g</div>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-xl">
                        <div class="text-xs text-slate-400 font-bold">Fats</div>
                        <div class="text-2xl font-bold text-slate-700" id="res-fat-target">0g</div>
                    </div>
                </div>
                <div class="bg-blue-50 border border-blue-100 p-4 rounded-xl text-blue-800 text-sm mb-6">
                    <span class="font-bold">üí° Next Step:</span> Upload your hostel menu file (Excel is best).
                </div>
                <button onclick="goToStep(3)" class="w-full py-4 bg-slate-800 hover:bg-slate-900 text-white font-semibold rounded-xl transition">
                    Upload My Menu üìÇ
                </button>
            </div>

            <!-- Screen 3: Upload -->
            <div id="s3" class="screen hidden">
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-slate-800">Upload Menu</h2>
                </div>
                <label class="upload-zone block w-full p-10 rounded-2xl cursor-pointer bg-slate-50 text-center border-2 border-dashed border-slate-200 hover:border-blue-400 transition">
                    <input type="file" id="fileInput" class="hidden" onchange="handleFile(event)">
                    <div class="mb-3"><div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-3">
                        <svg class="w-8 h-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                    </div></div>
                    <p class="font-semibold text-slate-700">Drop Excel or CSV file here</p>
                    <p class="text-xs text-slate-400 mt-1">The system will auto-sort dates.</p>
                </label>
                <div id="status-box" class="hidden mt-4 p-4 bg-slate-50 rounded-xl">
                    <div class="flex items-center space-x-3">
                        <div class="w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                        <span id="status-text" class="text-slate-600 text-sm">Reading...</span>
                    </div>
                </div>
                <div class="mt-6">
                    <label class="text-xs font-bold text-slate-400 uppercase">Select Day</label>
                    <select id="daySelect" disabled class="mt-2 w-full px-4 py-3.5 bg-slate-50 border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition disabled:opacity-50">
                        <option>Waiting for upload...</option>
                    </select>
                </div>
                <button onclick="goToStep(2)" class="w-full mt-4 py-3 text-slate-400 font-medium text-sm">‚Üê Back</button>
                <button id="generateBtn" onclick="analyzePlan()" disabled class="w-full mt-2 py-4 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-300 text-white font-semibold rounded-xl shadow-lg transition">
                    Generate Diet Plan üß†
                </button>
            </div>

            <!-- Screen 4: Results -->
            <div id="s4" class="screen hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">Your Diet Prescription üìã</h2>
                    <p class="text-slate-500 text-sm" id="res-date">Date</p>
                </div>
                
                <!-- Tally Box -->
                <div class="bg-slate-50 p-4 rounded-xl mb-4 border border-slate-200">
                    <h3 class="font-bold text-sm text-slate-600 mb-2">Diet Tally (Target vs Actual)</h3>
                    <div class="grid grid-cols-4 gap-2 text-center">
                        <div>
                            <div class="text-xs text-slate-400">Protein</div>
                            <div class="font-bold text-blue-600" id="tally-pro">0g / 0g</div>
                        </div>
                        <div>
                            <div class="text-xs text-slate-400">Carbs</div>
                            <div class="font-bold text-blue-600" id="tally-carb">0g / 0g</div>
                        </div>
                        <div>
                            <div class="text-xs text-slate-400">Fats</div>
                            <div class="font-bold text-blue-600" id="tally-fat">0g / 0g</div>
                        </div>
                        <div>
                            <div class="text-xs text-slate-400">Calories</div>
                            <div class="font-bold text-blue-600" id="tally-cal">0 / 0</div>
                        </div>
                    </div>
                </div>

                <div id="gap-alert" class="p-4 rounded-xl mb-4 bg-yellow-50 border border-yellow-100 hidden">
                    <div class="flex items-start space-x-2">
                        <div class="text-xl">üí°</div>
                        <div>
                            <h3 class="font-bold text-yellow-800 text-sm">Smart Suggestion</h3>
                            <p class="text-yellow-700 text-xs mt-1" id="gap-text">Info</p>
                        </div>
                    </div>
                </div>

                <div id="mealsContainer" class="space-y-3 max-h-80 overflow-y-auto pr-2"></div>

                <div class="mt-8 space-y-3">
                    <button onclick="downloadPDF()" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-lg">Download Detailed PDF üì•</button>
                    <button onclick="goToStep(3)" class="w-full py-3 text-slate-500 font-medium text-sm hover:text-slate-700 transition">Check Another Day</button>
                </div>
            </div>

        </div>
    </div>

<script>
    // --- Core App Logic ---
    let USER = { goals: {} };
    let PARSED_MENU = [];
    let CURRENT_PLAN = {};
    let FINAL_TOTALS = { p: 0, c: 0, f: 0, cal: 0 };
    let heightMode = 'cm';

    function goToStep(step) {
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById('s'+step).classList.remove('hidden');
        window.scrollTo(0,0);
    }

    function setHeightMode(mode) {
        heightMode = mode;
        const btnCm = document.getElementById('btn-cm');
        const btnFt = document.getElementById('btn-ft');
        if (mode === 'cm') {
            btnCm.className = 'text-xs px-2 py-1 rounded bg-blue-100 text-blue-700 font-semibold transition';
            btnFt.className = 'text-xs px-2 py-1 rounded text-slate-500 transition';
        } else {
            btnFt.className = 'text-xs px-2 py-1 rounded bg-blue-100 text-blue-700 font-semibold transition';
            btnCm.className = 'text-xs px-2 py-1 rounded text-slate-500 transition';
        }
        document.getElementById('input-cm').classList.toggle('hidden', mode !== 'cm');
        document.getElementById('input-ft').classList.toggle('hidden', mode !== 'ft');
    }

    function calculateGoals() {
        const w = parseFloat(document.getElementById('weight').value);
        let h = 0;
        if (heightMode === 'cm') h = parseFloat(document.getElementById('heightCM').value);
        else {
            const ft = parseFloat(document.getElementById('heightFt').value) || 0;
            const inch = parseFloat(document.getElementById('heightIn').value) || 0;
            h = (ft * 30.48) + (inch * 2.54);
        }
        const a = parseFloat(document.getElementById('age').value);
        const gender = document.getElementById('gender').value;
        const goal = document.getElementById('goal').value;

        if (!w || !h || !a) { alert("Please fill all fields!"); return; }

        USER.name = document.getElementById('userName').value || "User";
        USER.goalType = goal;
        USER.diet = document.getElementById('dietType').value;

        let bmr = (gender === 'male') ? (10*w)+(6.25*h)-(5*a)+5 : (10*w)+(6.25*h)-(5*a)-161;
        let tdee = bmr * 1.55;
        if(goal === 'loss') tdee -= 500;
        if(goal === 'gain') tdee += 300;

        USER.goals.calories = Math.round(tdee);
        USER.goals.protein = Math.round( (goal === 'gain' ? w * 2.2 : w * 1.6) );
        USER.goals.carbs = Math.round( (tdee * 0.5) / 4 );
        USER.goals.fats = Math.round( (tdee * 0.25) / 9 );

        document.getElementById('res-cal-target').innerText = USER.goals.calories;
        document.getElementById('res-pro-target').innerText = USER.goals.protein + "g";
        document.getElementById('res-carb-target').innerText = USER.goals.carbs + "g";
        document.getElementById('res-fat-target').innerText = USER.goals.fats + "g";

        goToStep(2);
    }

    async function handleFile(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const statusBox = document.getElementById('status-box');
        const statusText = document.getElementById('status-text');
        statusBox.classList.remove('hidden');
        statusText.innerText = "Sorting Menu...";

        try {
            let data;
            if (file.name.toLowerCase().endsWith('.csv')) {
                const text = await file.text();
                const workbook = XLSX.read(text, {type: 'string'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            } else {
                data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            }
            parseMenuLogic(data);
            statusBox.classList.add('hidden');
        } catch (err) {
            console.error(err);
            statusText.innerText = "Error reading file.";
            alert("Could not read file.");
        }
    }

    function parseMenuLogic(rows) {
        PARSED_MENU = [];
        
        // 1. Find Header Row (contains dates/days)
        let headerIdx = -1;
        let dateColIndices = [];
        let dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

        for(let r = 0; r < Math.min(10, rows.length); r++) {
            let row = rows[r];
            if(!row) continue;
            
            let hasDate = false;
            for(let c = 0; c < row.length; c++) {
                let cell = String(row[c] || "");
                // Check for Date (2026/1/27) or Day Name (Monday)
                if(cell.match(/^\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}$/) || 
                   cell.match(/^\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}$/) ||
                   dayNames.some(d => cell.toLowerCase().includes(d.toLowerCase()))) 
                {
                    dateColIndices.push(c);
                    hasDate = true;
                }
            }
            if(hasDate) {
                headerIdx = r;
                break;
            }
        }

        if (headerIdx === -1) {
            alert("Could not find a valid date row.");
            return;
        }

        // 2. Extract and Group Data
        let tempMenu = [];

        dateColIndices.forEach(colIdx => {
            let dateLabel = String(rows[headerIdx][colIdx]);
            let dayPlan = { date: dateLabel, meals: { Breakfast: [], Lunch: [], Dinner: [] } };
            let currentCategory = "Lunch";

            for(let r = headerIdx + 1; r < rows.length; r++) {
                let row = rows[r];
                if(!row) continue;
                
                let catCheck = String(row[1] || row[0] || "").toUpperCase();
                if(catCheck.includes("BREAKFAST")) currentCategory = "Breakfast";
                else if(catCheck.includes("LUNCH")) currentCategory = "Lunch";
                else if(catCheck.includes("DINNER")) currentCategory = "Dinner";
                
                let item = String(row[colIdx] || "").trim();
                if(item.length > 2 && item !== "MENU GRID" && !item.includes("Sr.No")) {
                    dayPlan.meals[currentCategory].push(item);
                }
            }
            tempMenu.push(dayPlan);
        });

        // 3. Sort by Date
        tempMenu.sort((a, b) => {
            // Helper to parse "Monday", "Tuesday" or "2026/1/27"
            function getSortKey(str) {
                if (dayNames.some(d => str.includes(d))) {
                    // If it's a day name
                    let d = dayNames.find(d => str.includes(d));
                    return dayNames.indexOf(d); // 0-6
                } else {
                    // If it's a date string
                    return new Date(str).getTime();
                }
            }
            return getSortKey(a.date) - getSortKey(b.date);
        });

        PARSED_MENU = tempMenu;
        populateDates();
    }

    function populateDates() {
        const select = document.getElementById('daySelect');
        select.innerHTML = '';
        if(PARSED_MENU.length === 0) {
            select.innerHTML = '<option>No dates found</option>';
            return;
        }
        
        PARSED_MENU.forEach((d, i) => {
            let opt = document.createElement('option');
            opt.value = i;
            opt.innerText = d.date;
            select.appendChild(opt);
        });
        select.disabled = false;
        document.getElementById('generateBtn').disabled = false;
    }

    // --- Diet Logic ---
    const DB = {
        "Bread / Jam & Butter": { p: 3, c: 25, f: 5, cal: 150, unit: "2 Slices" },
        "Boiled Egg": { p: 6, c: 1, f: 5, cal: 70, unit: "1 Egg" },
        "Chapathi": { p: 3, c: 15, f: 2, cal: 90, unit: "1 Piece" },
        "Steamed Rice": { p: 4, c: 50, f: 0, cal: 220, unit: "1 Bowl (150g)" },
        "Sambar": { p: 5, c: 20, f: 5, cal: 130, unit: "1 Bowl" },
        "Dal Tadka": { p: 6, c: 20, f: 6, cal: 150, unit: "1 Bowl" },
        "Curd": { p: 4, c: 5, f: 5, cal: 80, unit: "1 Bowl" },
        "Banana": { p: 1, c: 25, f: 0, cal: 100, unit: "1 Piece" },
        "Default Veg": { p: 4, c: 20, f: 8, cal: 160, unit: "1 Bowl" },
        "Default NonVeg": { p: 20, c: 10, f: 15, cal: 260, unit: "1 Piece/Bowl" }
    };

    function getMacro(item) {
        if (DB[item]) return DB[item];
        if (item.toLowerCase().includes('chicken') || item.toLowerCase().includes('fish')) return DB["Default NonVeg"];
        if (item.toLowerCase().includes('paneer')) return { p: 12, c: 10, f: 15, cal: 240, unit: "1 Bowl" };
        return DB["Default Veg"];
    }

    function analyzePlan() {
        const idx = document.getElementById('daySelect').value;
        const dayData = PARSED_MENU[idx];
        
        // Reset totals
        FINAL_TOTALS = { p: 0, c: 0, f: 0, cal: 0 };
        let plan = { Breakfast: [], Lunch: [], Dinner: [] };

        function addItem(meal, item, qty = 1) {
            if(USER.diet === 'veg' && (item.toLowerCase().includes('chicken') || item.toLowerCase().includes('egg') || item.toLowerCase().includes('fish'))) return;
            
            let m = getMacro(item);
            let totP = m.p * qty;
            let totC = m.c * qty;
            let totF = m.f * qty;
            let totCal = m.cal * qty;

            FINAL_TOTALS.p += totP;
            FINAL_TOTALS.c += totC;
            FINAL_TOTALS.f += totF;
            FINAL_TOTALS.cal += totCal;

            plan[meal].push({ 
                name: item, 
                qty: qty, 
                unit: m.unit,
                p: totP, c: totC, f: totF, cal: totCal 
            });
        }

        // Add all mess items (Assuming 1 serving)
        dayData.meals.Breakfast.forEach(i => addItem("Breakfast", i, 1));
        dayData.meals.Lunch.forEach(i => addItem("Lunch", i, 1));
        dayData.meals.Dinner.forEach(i => addItem("Dinner", i, 1));

        // SMART GAP FILLING
        // 1. Check Protein Gap
        let proGap = USER.goals.protein - FINAL_TOTALS.p;
        if (proGap > 10 && USER.diet === 'non-veg') {
            let eggsNeeded = Math.ceil(proGap / 6); // 6g per egg
            addItem("Supplement (Cafe)", "Boiled Egg", eggsNeeded);
        }

        // 2. Check Calorie Gap
        let calGap = USER.goals.calories - FINAL_TOTALS.cal;
        if (calGap > 200) {
            // Add a banana
            addItem("Supplement (Cafe)", "Banana", 1);
        }

        CURRENT_PLAN = plan;
        renderResults(dayData.date);
    }

    function renderResults(date) {
        goToStep(4);
        document.getElementById('res-date').innerText = "Menu for: " + date;

        // Update Tally
        document.getElementById('tally-pro').innerText = `${Math.round(FINAL_TOTALS.p)}g / ${USER.goals.protein}g`;
        document.getElementById('tally-carb').innerText = `${Math.round(FINAL_TOTALS.c)}g / ${USER.goals.carbs}g`;
        document.getElementById('tally-fat').innerText = `${Math.round(FINAL_TOTALS.f)}g / ${USER.goals.fats}g`;
        document.getElementById('tally-cal').innerText = `${Math.round(FINAL_TOTALS.cal)} / ${USER.goals.calories}`;

        // Check Gaps
        let proGap = USER.goals.protein - FINAL_TOTALS.p;
        if (proGap > 5) {
            document.getElementById('gap-alert').classList.remove('hidden');
            document.getElementById('gap-text').innerText = `Your meal is low in protein by ${Math.round(proGap)}g. We have added Eggs/Banana to balance it.`;
        } else {
            document.getElementById('gap-alert').classList.add('hidden');
        }

        // Render Table
        let html = '';
        for(let m in CURRENT_PLAN) {
            if(CURRENT_PLAN[m].length === 0) continue;
            html += `
            <div class="bg-white border border-slate-200 rounded-xl overflow-hidden mb-3 shadow-sm">
                <div class="bg-slate-50 px-3 py-2 border-b border-slate-200 flex justify-between items-center">
                    <span class="font-bold text-slate-700 text-sm">${m}</span>
                </div>
                <div class="divide-y divide-slate-100">
                ${CURRENT_PLAN[m].map(i => `
                    <div class="p-3 flex justify-between items-center">
                        <div class="w-1/2">
                            <div class="font-semibold text-slate-800 text-sm">${i.name}</div>
                            <div class="text-xs text-slate-400">${i.qty} x ${i.unit}</div>
                        </div>
                        <div class="w-1/2 grid grid-cols-4 gap-1 text-center text-xs">
                            <div><span class="block text-slate-400">P</span><span class="font-bold text-blue-600">${i.p}g</span></div>
                            <div><span class="block text-slate-400">C</span><span class="font-bold text-green-600">${i.c}g</span></div>
                            <div><span class="block text-slate-400">F</span><span class="font-bold text-yellow-600">${i.f}g</span></div>
                            <div><span class="block text-slate-400">Cal</span><span class="font-bold text-slate-800">${i.cal}</span></div>
                        </div>
                    </div>
                `).join('')}
                </div>
            </div>`;
        }
        document.getElementById('mealsContainer').innerHTML = html;
    }

    function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const pageWidth = doc.internal.pageSize.getWidth();

        // Header
        doc.setFillColor(59, 130, 246); // Blue
        doc.rect(0, 0, pageWidth, 40, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(22);
        doc.text("UniFit Pro - Diet Prescription", pageWidth/2, 20, {align: 'center'});
        doc.setFontSize(12);
        doc.text("Date: " + document.getElementById('res-date').innerText, pageWidth/2, 30, {align: 'center'});

        // User Info
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(12);
        doc.text("User: " + USER.name, 14, 50);
        doc.text("Target Calories: " + USER.goals.calories + " kcal", 14, 58);
        doc.text("Target Protein: " + USER.goals.protein + "g", 14, 66);

        // Tally Box
        doc.setDrawColor(200);
        doc.roundedRect(14, 75, pageWidth-28, 20, 3, 3, 'S');
        doc.setFontSize(10);
        doc.text("Actual Totals:", 20, 85);
        doc.text(`Protein: ${Math.round(FINAL_TOTALS.p)}g`, 80, 85);
        doc.text(`Carbs: ${Math.round(FINAL_TOTALS.c)}g`, 110, 85);
        doc.text(`Fats: ${Math.round(FINAL_TOTALS.f)}g`, 140, 85);
        doc.text(`Calories: ${Math.round(FINAL_TOTALS.cal)}`, 80, 92);

        // Meal Table
        let y = 105;
        const keys = Object.keys(CURRENT_PLAN);

        keys.forEach(meal => {
            if(y > 260) { doc.addPage(); y = 20; }
            
            // Meal Header
            doc.setFillColor(241, 245, 249);
            doc.rect(14, y, pageWidth-28, 8, 'F');
            doc.setFontSize(11);
            doc.setTextColor(51, 65, 85);
            doc.text(meal, 16, y+6);
            y += 10;

            // Items
            doc.setFontSize(9);
            doc.setTextColor(0, 0, 0);
            CURRENT_PLAN[meal].forEach(i => {
                if(y > 280) { doc.addPage(); y = 20; }
                
                // Item Name
                doc.setFont("helvetica", "bold");
                doc.text(i.name, 16, y);
                doc.setFont("helvetica", "normal");
                doc.setTextColor(100);
                doc.text(`(${i.qty} x ${i.unit})`, 16, y+4);
                
                // Macros
                doc.setTextColor(0);
                doc.text(`P: ${i.p}g`, 120, y);
                doc.text(`C: ${i.c}g`, 140, y);
                doc.text(`F: ${i.f}g`, 160, y);
                doc.text(`Cal: ${i.cal}`, 180, y);

                y += 10;
            });
        });

        doc.save("UniFit_Diet_Plan.pdf");
    }

</script>
</body>
</html>
